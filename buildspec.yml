version: 0.2
phases:
  build:
    commands:
      - aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 666398651410.dkr.ecr.eu-west-1.amazonaws.com
      - docker build -t test:test1 .
      - docker push test:test1
      - echo Updating ECR image tags...
      - LATEST_IMAGE=$(aws ecr describe-images --repository-name $REPOSITORY_NAME --query 'sort_by(imageDetails,& imagePushedAt)[-1]' --output json | jq -r '.imageDigest')
      - if [ -n "$LATEST_IMAGE" ]; then aws ecr batch-delete-image --repository-name $REPOSITORY_NAME --image-ids imageDigest=$LATEST_IMAGE; fi
      - aws ecr put-image-tag-mutability --repository-name $REPOSITORY_NAME --image-tag $CODEBUILD_RESOLVED_SOURCE_VERSION --image-tag-mutability IMMUTABLE
      - aws ecr put-image-tag-mutability --repository-name $REPOSITORY_NAME --image-tag latest --image-tag-mutability IMMUTABLE
      - echo Deploying to Amazon ECS...
      - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment
artifacts:
  files: []
