version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 666398651410.dkr.ecr.eu-west-1.amazonaws.com
  build:
    commands:
      - echo Building Docker image...
      - sudo systemctl start docker
      - docker build -t $REPOSITORY_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION .
      - docker tag $REPOSITORY_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION $REPOSITORY_URI:latest
  post_build:
    commands:
      - echo Pushing Docker images to Amazon ECR...
      - docker push $REPOSITORY_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - docker push $REPOSITORY_URI:latest
      - echo Updating ECR image tags...
      - LATEST_IMAGE=$(aws ecr describe-images --repository-name $REPOSITORY_NAME --query 'sort_by(imageDetails,& imagePushedAt)[-1]' --output json | jq -r '.imageDigest')
      - if [ -n "$LATEST_IMAGE" ]; then aws ecr batch-delete-image --repository-name $REPOSITORY_NAME --image-ids imageDigest=$LATEST_IMAGE; fi
      - aws ecr put-image-tag-mutability --repository-name $REPOSITORY_NAME --image-tag $CODEBUILD_RESOLVED_SOURCE_VERSION --image-tag-mutability IMMUTABLE
      - aws ecr put-image-tag-mutability --repository-name $REPOSITORY_NAME --image-tag latest --image-tag-mutability IMMUTABLE
      - echo Deploying to Amazon ECS...
      - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment

artifacts:
  files: []
